{{ define "content" }}
<div class="container" style="max-width: 800px; margin: 0 auto;">
  <h1>Settings</h1>

  <!-- Telegram Auth -->
  <article id="telegram-auth-card" aria-label="Telegram Connection">
    <header>
      <h2>Telegram Connection</h2>
    </header>

    <div id="auth-status" role="status" aria-live="polite">
      <small>Status:</small>
      <span id="connection-status" data-initial="true">Wait...</span>
    </div>

    <figure id="qr-container" hidden class="center-align" style="text-align: center; padding: 2rem; background: #fff; border-radius: 8px; border: 1px solid var(--muted-border-color);">
      <p style="margin-bottom: 1rem; color: #000;">Scan with Telegram App</p>
      <div id="qr-code" style="padding: 1rem; display: inline-block; background: #fff; border: 4px solid #000;"></div>
      <p id="qr-timer" style="margin-top: 1rem;">
        <small>Expires in <span id="qr-timeout">60</span>s</small>
      </p>
      <p style="margin-top: 0.5rem;"><small>QR code expires automatically</small></p>
    </figure>

    <div id="connect-btn-container">
      <button
        id="connect-btn"
        hx-post="/api/v1/auth/qr"
        hx-swap="none"
        hx-trigger="load"
      >
        Connect Telegram
      </button>
    </div>
  </article>

  <script src="https://unpkg.com/qrcodejs/qrcode.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const socket = new WebSocket(
        (location.protocol === "https:" ? "wss://" : "ws://") +
          location.host +
          "/ws"
      );
      const qrContainer = document.getElementById("qr-container");
      const qrCodeDiv = document.getElementById("qr-code");
      const statusSpan = document.getElementById("connection-status");
      const connectBtn = document.getElementById("connect-btn");

      // Check initial status
      fetch("/api/v1/scrape/status")
        .then((r) => r.json())
        .then((data) => {
          if (data.telegram_status === "READY") {
            statusSpan.textContent = "Connected";
            statusSpan.style.color = "var(--success)";
            connectBtn.hidden = true;
          } else {
            statusSpan.textContent = "Disconnected";
            statusSpan.style.color = "var(--error)";
          }
        });

      socket.onmessage = function (event) {
        const msg = JSON.parse(event.data);
        if (msg.type === "tg_qr") {
          qrContainer.hidden = false;
          qrCodeDiv.innerHTML = "";
          new QRCode(qrCodeDiv, msg.url);
          statusSpan.textContent = "Scan QR Code...";
          statusSpan.style.color = "var(--warning)";

          // Start QR expiration timer (60 seconds)
          let timeLeft = 60;
          const timerSpan = document.getElementById("qr-timeout");
          const timerInterval = setInterval(function () {
            timeLeft--;
            if (timerSpan) timerSpan.textContent = timeLeft;
            if (timeLeft <= 0) {
              clearInterval(timerInterval);
              qrContainer.hidden = true;
              qrCodeDiv.innerHTML = "";
              statusSpan.textContent = "QR expired. Try again.";
              statusSpan.style.color = "var(--error)";
            }
          }, 1000);

          qrContainer.dataset.timerInterval = timerInterval;
        } else if (msg.type === "tg_auth_success") {
          const timerInterval = qrContainer.dataset.timerInterval;
          if (timerInterval) {
            clearInterval(parseInt(timerInterval));
            delete qrContainer.dataset.timerInterval;
          }

          qrContainer.hidden = true;
          qrCodeDiv.innerHTML = "";
          statusSpan.textContent = "Connected";
          statusSpan.style.color = "var(--success)";
          connectBtn.hidden = true;
        } else if (msg.type === "error") {
          const timerInterval = qrContainer.dataset.timerInterval;
          if (timerInterval) {
            clearInterval(parseInt(timerInterval));
            delete qrContainer.dataset.timerInterval;
          }

          alert("Error: " + msg.message);
          qrContainer.hidden = true;
          statusSpan.textContent = "Disconnected";
          statusSpan.style.color = "var(--error)";
        }
      };
    });
  </script>

  <!-- Add Target Form -->
  <article aria-label="Add New Target">
    <header>
      <h2>Add New Target</h2>
    </header>

    <form
      hx-post="/api/v1/targets"
      hx-target="#targets-list"
      hx-swap="beforeend"
    >
      <div class="grid">
        <label for="target-name">Name</label>
        <input type="text" id="target-name" name="name" required>

        <label for="target-type">Type</label>
        <select id="target-type" name="type">
          <option value="TG_CHANNEL">Telegram Channel</option>
          <option value="TG_FORUM">Telegram Forum</option>
          <option value="HH_SEARCH">HH Search</option>
        </select>

        <label for="target-url">URL / ID / Username</label>
        <input type="text" id="target-url" name="url" required placeholder="@username or https://...">
      </div>

      <button type="submit">Add Target</button>
    </form>
  </article>

  <!-- Targets List -->
  <section aria-label="Scraping Targets">
    <h2>Scraping Targets</h2>
    <div
      id="targets-list"
      hx-get="/api/v1/targets"
      hx-trigger="load"
    >
      <small>Loading targets...</small>
    </div>
  </section>
</div>
{{ end }}
