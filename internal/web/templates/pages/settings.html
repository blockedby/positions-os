{{ define "content" }}
<div class="container" style="max-width: 800px; margin: 0 auto;">
  <h1>Settings</h1>

  <!-- Telegram Auth -->
  <article id="telegram-auth-card" aria-label="Telegram Connection">
    <header>
      <h2>Telegram Connection</h2>
    </header>

    <div id="auth-status" role="status" aria-live="polite">
      <small>Status:</small>
      <span id="connection-status" data-initial="true">Wait...</span>
    </div>

    <figure id="qr-container" hidden class="center-align" style="text-align: center; padding: 2rem; background: #fff; border-radius: 8px; border: 1px solid var(--muted-border-color);">
      <p style="margin-bottom: 1rem; color: #000;">Scan with Telegram App</p>
      <div id="qr-code" style="padding: 1rem; display: inline-block; background: #fff; border: 4px solid #000;"></div>
      <p id="qr-timer" style="margin-top: 1rem;">
        <small>Expires in <span id="qr-timeout">30</span>s</small>
      </p>
      <p style="margin-top: 0.5rem;"><small>QR code expires automatically</small></p>
    </figure>

    <div id="connect-btn-container">
      <button
        id="connect-btn"
        hx-post="/api/v1/auth/qr"
        hx-swap="none"
      >
        Connect Telegram
      </button>
    </div>
  </article>

  <script src="https://unpkg.com/qrcodejs/qrcode.min.js"></script>
  <script>
    (function () {
      const qrContainer = document.getElementById("qr-container");
      const qrCodeDiv = document.getElementById("qr-code");
      const statusSpan = document.getElementById("connection-status");
      const connectBtn = document.getElementById("connect-btn");
      let currentQRTimer = null;
      let lastQRUrl = null;

      // QR Persistence Module - saves QR to localStorage for page reload recovery
      const QR_PERSISTENCE = {
        STORAGE_KEY_URL: "tg_qr_url",
        STORAGE_KEY_TIMESTAMP: "tg_qr_timestamp",
        QR_EXPIRY_SECONDS: 30,

        save: function (url) {
          try {
            localStorage.setItem(this.STORAGE_KEY_URL, url);
            localStorage.setItem(this.STORAGE_KEY_TIMESTAMP, Date.now().toString());
          } catch (e) {
            console.warn("Failed to save QR to localStorage:", e);
          }
        },

        load: function () {
          try {
            const url = localStorage.getItem(this.STORAGE_KEY_URL);
            const timestamp = localStorage.getItem(this.STORAGE_KEY_TIMESTAMP);
            if (!url || !timestamp) return null;

            const ageSeconds = (Date.now() - parseInt(timestamp)) / 1000;
            if (ageSeconds > this.QR_EXPIRY_SECONDS) {
              this.clear();
              return null;
            }
            return { url, ageSeconds: Math.floor(ageSeconds) };
          } catch (e) {
            console.warn("Failed to load QR from localStorage:", e);
            return null;
          }
        },

        clear: function () {
          try {
            localStorage.removeItem(this.STORAGE_KEY_URL);
            localStorage.removeItem(this.STORAGE_KEY_TIMESTAMP);
          } catch (e) {
            console.warn("Failed to clear QR from localStorage:", e);
          }
        },
      };

      // Display QR code with optional initial time left
      function displayQR(url, initialTimeLeft) {
        const timeLeft = initialTimeLeft !== undefined ? initialTimeLeft : 30;

        // Clear any existing timer
        if (currentQRTimer) {
          clearInterval(currentQRTimer);
        }

        qrContainer.hidden = false;
        qrCodeDiv.innerHTML = "";
        new QRCode(qrCodeDiv, url);
        lastQRUrl = url;
        statusSpan.textContent = "Scan QR Code...";
        statusSpan.style.color = "var(--warning)";

        // Start QR expiration timer
        const timerSpan = document.getElementById("qr-timeout");
        timerSpan.textContent = timeLeft;

        currentQRTimer = setInterval(function () {
          const currentTimeLeft = parseInt(timerSpan.textContent) - 1;
          timerSpan.textContent = currentTimeLeft;
          if (currentTimeLeft <= 0) {
            clearInterval(currentQRTimer);
            currentQRTimer = null;
            lastQRUrl = null;
            QR_PERSISTENCE.clear();
            qrContainer.hidden = true;
            qrCodeDiv.innerHTML = "";
            statusSpan.textContent = "QR expired. Try again.";
            statusSpan.style.color = "var(--error)";
          }
        }, 1000);
      }

      // Check initial status and restore QR if available
      function init() {
        fetch("/api/v1/scrape/status")
          .then((r) => r.json())
          .then((data) => {
            if (data.telegram_status === "READY") {
              statusSpan.textContent = "Connected";
              statusSpan.style.color = "var(--success)";
              connectBtn.hidden = true;
              QR_PERSISTENCE.clear(); // Clear any stale QR data
            } else {
              statusSpan.textContent = "Disconnected";
              statusSpan.style.color = "var(--error)";

              // Try to restore QR from localStorage
              const savedQR = QR_PERSISTENCE.load();
              if (savedQR) {
                // QR is still valid, display it immediately
                displayQR(savedQR.url, 30 - savedQR.ageSeconds);
              }
            }
          })
          .catch((err) => {
            console.error("Failed to check status:", err);
            statusSpan.textContent = "Error checking status";
            statusSpan.style.color = "var(--error)";
          });
      }

      // Initialize on page load
      init();

      // Add click debouncing to the connect button
      connectBtn.addEventListener("click", function () {
        if (connectBtn.disabled) {
          return;
        }
        connectBtn.disabled = true;
        connectBtn.textContent = "Connecting...";

        // Re-enable after a delay
        setTimeout(() => {
          connectBtn.disabled = false;
          connectBtn.textContent = "Connect Telegram";
        }, 3000);
      });

      // Listen for custom QR events from global WebSocket
      document.addEventListener("tg_qr", function (e) {
        const url = e.detail.url;
        // Skip if this is the same QR we already displayed
        if (url === lastQRUrl) {
          return;
        }

        // Save to localStorage for persistence across reloads
        QR_PERSISTENCE.save(url);

        displayQR(url, 30);
      });

      document.addEventListener("tg_auth_success", function () {
        // Clear timer and stored QR
        if (currentQRTimer) {
          clearInterval(currentQRTimer);
          currentQRTimer = null;
        }
        lastQRUrl = null;
        QR_PERSISTENCE.clear();

        qrContainer.hidden = true;
        qrCodeDiv.innerHTML = "";
        statusSpan.textContent = "Connected";
        statusSpan.style.color = "var(--success)";
        connectBtn.hidden = true;
      });

      document.addEventListener("tg_auth_error", function (e) {
        // Clear timer and stored QR
        if (currentQRTimer) {
          clearInterval(currentQRTimer);
          currentQRTimer = null;
        }
        lastQRUrl = null;
        QR_PERSISTENCE.clear();

        console.error("Auth error:", e.detail.message);
        qrContainer.hidden = true;
        statusSpan.textContent = "Disconnected";
        statusSpan.style.color = "var(--error)";
        connectBtn.disabled = false;
        connectBtn.textContent = "Connect Telegram";
      });
    })();
  </script>

  <!-- Add Target Form -->
  <article aria-label="Add New Target">
    <header>
      <h2>Add New Target</h2>
    </header>

    <form
      hx-post="/api/v1/targets"
      hx-target="#targets-list"
      hx-swap="beforeend"
    >
      <div class="grid">
        <label for="target-name">Name</label>
        <input type="text" id="target-name" name="name" required>

        <label for="target-type">Type</label>
        <select id="target-type" name="type">
          <option value="TG_CHANNEL">Telegram Channel</option>
          <option value="TG_FORUM">Telegram Forum</option>
          <option value="HH_SEARCH">HH Search</option>
        </select>

        <label for="target-url">URL / ID / Username</label>
        <input type="text" id="target-url" name="url" required placeholder="@username or https://...">
      </div>

      <button type="submit">Add Target</button>
    </form>
  </article>

  <!-- Targets List -->
  <section aria-label="Scraping Targets">
    <h2>Scraping Targets</h2>
    <div
      id="targets-list"
      hx-get="/api/v1/targets"
      hx-trigger="load"
    >
      <small>Loading targets...</small>
    </div>
  </section>
</div>
{{ end }}
