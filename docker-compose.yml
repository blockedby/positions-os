# ============================================================
# job-hunter-os - docker compose configuration
# ============================================================
# syntax=docker/dockerfile:1.7

services:
  # --------------------------------------------------------
  # core infrastructure
  # --------------------------------------------------------
  
  postgres:
    image: postgres:16-alpine
    container_name: jhos-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-jhos}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-jhos_secret}
      POSTGRES_DB: ${POSTGRES_DB:-jhos}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-jhos}"]
      interval: 10s
      timeout: 5s
      retries: 5

  nats:
    image: nats:2.10-alpine
    container_name: jhos-nats
    restart: unless-stopped
    command: ["--jetstream", "--store_dir=/data"]
    ports:
      - "4222:4222"   # client connections
      - "8222:8222"   # http monitoring
    volumes:
      - nats_data:/data
    healthcheck:
      test: ["CMD", "nats-server", "--help"]
      interval: 10s
      timeout: 5s
      retries: 3

  # DEPRECATED: Migrations now run automatically on collector/analyzer startup.
  # This service is kept only for manual operations (rollback, force version, etc.)
  # Usage: docker compose --profile tools run migrate down 1
  migrate:
    image: migrate/migrate:latest
    container_name: jhos-migrate
    volumes:
      - ./migrations:/migrations
    command: [
      "-path=/migrations",
      "-database=postgres://${POSTGRES_USER:-jhos}:${POSTGRES_PASSWORD:-jhos_secret}@postgres:5432/${POSTGRES_DB:-jhos}?sslmode=disable",
      "up"
    ]
    depends_on:
      postgres:
        condition: service_healthy
    profiles:
      - tools  # only run explicitly: docker compose --profile tools run migrate

  # --------------------------------------------------------
  # application services
  # --------------------------------------------------------

  collector:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jhos-collector
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    ports:
      - "3100:3100"
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-jhos}:${POSTGRES_PASSWORD:-jhos_secret}@postgres:5432/${POSTGRES_DB:-jhos}?sslmode=disable
      NATS_URL: nats://nats:4222
      TG_API_ID: ${TG_API_ID}
      TG_API_HASH: ${TG_API_HASH}
      HTTP_PORT: 3100
      LOG_LEVEL: info
      STATIC_DIR: /root/static
      TEMPLATES_DIR: /root/internal/web/templates

  analyzer:
    build:
      context: .
      dockerfile: Dockerfile.analyzer
    container_name: jhos-analyzer
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-jhos}:${POSTGRES_PASSWORD:-jhos_secret}@postgres:5432/${POSTGRES_DB:-jhos}?sslmode=disable
      NATS_URL: nats://nats:4222
      LLM_BASE_URL: ${LLM_BASE_URL:-http://host.docker.internal:1234/v1}
      LLM_MODEL: ${LLM_MODEL:-local-model}
      LLM_API_KEY: ${LLM_API_KEY}
      LLM_MAX_TOKENS: ${LLM_MAX_TOKENS:-2048}
      LLM_TEMPERATURE: ${LLM_TEMPERATURE:-0.1}
      LLM_TIMEOUT_SECONDS: ${LLM_TIMEOUT_SECONDS:-60}
      LOG_LEVEL: debug
    extra_hosts:
      - "host.docker.internal:host-gateway"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: jhos-frontend
    restart: unless-stopped
    depends_on:
      collector:
        condition: service_started
    ports:
      - "3000:80"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # --------------------------------------------------------
  # tests
  # --------------------------------------------------------

  integration-tests:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: jhos-integration-tests
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    environment:
      INTEGRATION_TEST: "1"
      DATABASE_URL: postgres://${POSTGRES_USER:-jhos}:${POSTGRES_PASSWORD:-jhos_secret}@postgres:5432/${POSTGRES_DB:-jhos}?sslmode=disable
      NATS_URL: nats://nats:4222
    profiles:
      - test

  # Frontend unit tests
  frontend-unit-tests:
    build:
      context: ./frontend
      dockerfile: Dockerfile.test
    container_name: jhos-frontend-unit-tests
    command: ["bun", "run", "test"]
    profiles:
      - test

  # DEPRECATED: Use docker-compose.e2e.yml for ephemeral E2E tests
  # This service shares the dev database and may leave orphaned test data.
  # Usage: docker compose -f docker-compose.e2e.yml up --abort-on-container-exit
  frontend-e2e-tests:
    build:
      context: ./frontend
      dockerfile: Dockerfile.test
    container_name: jhos-frontend-e2e-tests
    command: ["bun", "playwright", "test", "--reporter=list"]
    environment:
      BASE_URL: http://frontend:80
      API_BASE_URL: http://collector:3100
    depends_on:
      collector:
        condition: service_started
      frontend:
        condition: service_healthy
    profiles:
      - test

volumes:
  postgres_data:
  nats_data:
  ollama_data:

networks:
  default:
    name: jhos-network
